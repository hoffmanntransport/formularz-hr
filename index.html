<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hoffmann Transport ‚Äì Ocena HR</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root{--primary:#D4A017;--primary-dark:#B8860B;--bg:#0D0D0D;--bg2:#151515;--bg3:#1E1E1E;--border:#2A2A2A;--text:#E8E8E0;--text-muted:#888;--success:#2ECC71;--error:#E74C3C;--warning:#F39C12;--info:#3498DB;--radius:6px}
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Barlow',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:15px;line-height:1.5}
  header{background:var(--bg2);border-bottom:3px solid var(--primary);position:sticky;top:0;z-index:100;box-shadow:0 4px 30px rgba(0,0,0,.5)}
  .header-inner{max-width:960px;margin:0 auto;padding:18px 24px;display:flex;align-items:center;justify-content:space-between;gap:20px}
  .logo-area h1{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:800;letter-spacing:2px;text-transform:uppercase;color:var(--primary);line-height:1}
  .logo-area span{font-size:11px;text-transform:uppercase;letter-spacing:3px;color:var(--text-muted);display:block;margin-top:4px}
  .hr-badge{background:rgba(212,160,23,.15);border:1px solid var(--primary);color:var(--primary);padding:6px 16px;border-radius:20px;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:2px;text-transform:uppercase}
  main{max-width:960px;margin:0 auto;padding:40px 24px 80px}
  .page-title{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;text-transform:uppercase;letter-spacing:3px;margin-bottom:6px}
  .page-title span{color:var(--primary)}
  .page-sub{color:var(--text-muted);font-size:12px;letter-spacing:2px;text-transform:uppercase;margin-bottom:32px;padding-bottom:20px;border-bottom:1px solid var(--border)}
  .candidate-card{background:linear-gradient(135deg,rgba(212,160,23,.08),rgba(212,160,23,.02));border:1px solid rgba(212,160,23,.35);border-radius:12px;padding:28px;margin-bottom:32px}
  .card-header{display:flex;align-items:flex-start;justify-content:space-between;gap:20px;margin-bottom:24px;flex-wrap:wrap}
  .card-name{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--primary)}
  .card-ref{font-size:12px;color:var(--text-muted);letter-spacing:1px;margin-top:4px}
  .status-pill{padding:6px 16px;border-radius:20px;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;white-space:nowrap}
  .status-new{background:rgba(52,152,219,.15);border:1px solid var(--info);color:var(--info)}
  .status-accepted{background:rgba(46,204,113,.15);border:1px solid var(--success);color:var(--success)}
  .status-rejected{background:rgba(231,76,60,.15);border:1px solid var(--error);color:var(--error)}
  .info-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px}
  @media(max-width:640px){.info-grid{grid-template-columns:1fr 1fr}.header-inner{flex-direction:column}}
  @media(max-width:420px){.info-grid{grid-template-columns:1fr}}
  .info-label{font-size:10px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:4px;font-weight:600}
  .info-value{font-size:14px;font-weight:500;color:var(--text)}
  .info-value.highlight{color:var(--primary);font-weight:600}
  .section{background:var(--bg2);border:1px solid var(--border);border-radius:10px;margin-bottom:20px;overflow:hidden}
  .section-header{padding:14px 22px;background:var(--bg3);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px}
  .section-num{font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;color:var(--primary);letter-spacing:1px;background:rgba(212,160,23,.1);padding:3px 9px;border-radius:4px}
  .section-label{font-size:13px;font-weight:600;text-transform:uppercase;letter-spacing:1px}
  .section-body{padding:22px}
  label.field-label{display:block;font-size:11px;font-weight:600;text-transform:uppercase;letter-spacing:1.5px;color:var(--text-muted);margin-bottom:8px}
  label.field-label .req{color:var(--primary);margin-left:3px}
  input[type="text"],input[type="date"],select,textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:11px 15px;border-radius:var(--radius);font-family:'Barlow',sans-serif;font-size:15px;outline:none;transition:border-color .2s}
  input:focus,select:focus,textarea:focus{border-color:var(--primary)}
  select option{background:var(--bg2)}
  textarea{resize:vertical;min-height:90px}
  .field-group{margin-bottom:18px}
  .field-row{display:grid;gap:16px;margin-bottom:18px}
  .col-2{grid-template-columns:1fr 1fr}
  @media(max-width:600px){.col-2{grid-template-columns:1fr}}
  .options-grid{display:grid;gap:10px}
  .cols-2{grid-template-columns:1fr 1fr}
  @media(max-width:500px){.cols-2{grid-template-columns:1fr}}
  .option-item{display:flex;align-items:center;gap:10px;padding:11px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius);cursor:pointer;transition:all .15s;user-select:none}
  .option-item:hover{border-color:#3A3A3A}
  .option-item input{display:none}
  .option-item .radio-box{width:18px;height:18px;border:2px solid #444;border-radius:50%;flex-shrink:0;transition:all .15s;position:relative}
  .option-item input[type="radio"]:checked+.radio-box{border-color:var(--primary)}
  .option-item input[type="radio"]:checked+.radio-box::after{content:'';width:8px;height:8px;background:var(--primary);border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
  .option-item.checked{border-color:var(--primary);background:rgba(212,160,23,.05)}
  .option-label{font-size:13px;font-weight:500}
  .checklist{display:flex;flex-direction:column;gap:8px}
  .check-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius)}
  .check-row-label{font-size:13px}
  .check-toggle{display:flex;gap:8px}
  .check-toggle label{display:flex;align-items:center;gap:6px;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:12px;font-weight:600;border:1px solid var(--border);transition:all .15s;color:#666}
  .check-toggle input{display:none}
  .check-toggle input:checked+label.yes-lbl{background:rgba(46,204,113,.15);border-color:var(--success);color:var(--success)}
  .check-toggle input:checked+label.no-lbl{background:rgba(231,76,60,.15);border-color:var(--error);color:var(--error)}
  .decision-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:8px}
  .decision-btn{display:flex;align-items:center;justify-content:center;gap:10px;padding:18px;border:2px solid var(--border);border-radius:8px;cursor:pointer;transition:all .2s;font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px;text-transform:uppercase;user-select:none;background:var(--bg)}
  .decision-btn input{display:none}
  .decision-btn.accept:hover,.decision-btn.accept.selected{border-color:var(--success);background:rgba(46,204,113,.08);color:var(--success)}
  .decision-btn.reject:hover,.decision-btn.reject.selected{border-color:var(--error);background:rgba(231,76,60,.08);color:var(--error)}
  .rating-row{display:flex;gap:8px;margin-top:8px}
  .star{font-size:28px;cursor:pointer;color:#333;transition:color .15s;user-select:none}
  .star.active{color:var(--primary)}
  .rating-label{font-size:12px;color:var(--text-muted);margin-top:6px}
  .submit-area{margin-top:36px;text-align:center}
  .submit-btn{background:var(--primary);color:#000;border:none;padding:16px 56px;font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:800;letter-spacing:3px;text-transform:uppercase;border-radius:var(--radius);cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:10px}
  .submit-btn:hover:not(:disabled){background:var(--primary-dark);transform:translateY(-1px)}
  .submit-btn:disabled{opacity:.5;cursor:not-allowed;transform:none}
  .spinner{width:16px;height:16px;border:2px solid rgba(0,0,0,.3);border-top-color:#000;border-radius:50%;animation:spin .7s linear infinite;display:none}
  .submit-btn.loading .spinner{display:block}
  .submit-btn.loading .btn-text{display:none}
  @keyframes spin{to{transform:rotate(360deg)}}
  .upload-progress{display:none;margin-top:22px;background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:22px}
  .upload-progress.visible{display:block}
  .upload-progress-title{font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--primary);margin-bottom:14px}
  .upload-step{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);font-size:13px}
  .upload-step:last-child{border-bottom:none}
  .step-icon{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;flex-shrink:0;background:var(--bg3);border:1px solid var(--border)}
  .step-icon.running{background:rgba(212,160,23,.15);border-color:var(--primary);animation:pulse 1s infinite}
  .step-icon.done{background:rgba(46,204,113,.15);border-color:var(--success);color:var(--success)}
  .step-icon.fail{background:rgba(231,76,60,.15);border-color:var(--error);color:var(--error)}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
  .step-label{color:var(--text-muted);flex:1}
  .step-label.running{color:var(--text)}
  .step-label.fail{color:var(--error)}
  .success-screen{display:none;text-align:center;padding:70px 24px}
  .success-screen.visible{display:block}
  .success-icon{font-size:60px;margin-bottom:20px}
  .success-title{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:800;text-transform:uppercase;letter-spacing:3px;color:var(--success);margin-bottom:10px}
  .success-text{color:var(--text-muted);font-size:14px}
  .loading-screen{text-align:center;padding:80px 24px}
  .loading-screen.hidden{display:none}
  .loading-spinner{width:48px;height:48px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 20px}
  .error-screen{display:none;text-align:center;padding:70px 24px}
  .error-screen.visible{display:block}
  .error-title{font-family:'Barlow Condensed',sans-serif;font-size:28px;font-weight:800;color:var(--error);margin-bottom:10px;text-transform:uppercase;letter-spacing:2px}
  .error-text{color:var(--text-muted);font-size:13px;margin-top:8px;line-height:1.8}
  .toast{position:fixed;bottom:22px;right:22px;background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px 16px;font-size:13px;max-width:340px;z-index:9999;display:flex;align-items:flex-start;gap:10px;transform:translateY(100px);opacity:0;transition:all .3s;box-shadow:0 10px 40px rgba(0,0,0,.5)}
  .toast.show{transform:translateY(0);opacity:1}
  .toast.toast-error{border-color:var(--error)}
  .toast.toast-success{border-color:var(--success)}
  .toast.toast-warn{border-color:var(--warning)}
  .toast-icon{font-size:16px;flex-shrink:0}
  .toast-body{flex:1}
  .toast-title{font-weight:600;margin-bottom:2px}
  .toast-msg{color:var(--text-muted);font-size:11px}
  .field-error{color:var(--error);font-size:11px;margin-top:5px;display:none}
  .field-group.has-error input,.field-group.has-error select{border-color:var(--error)}
  .field-group.has-error .field-error{display:block}
</style>
</head>
<body>
<header>
  <div class="header-inner">
    <div class="logo-area">
      <h1>Hoffmann Transport</h1>
      <span>Panel Oceny HR ‚Äì Kandydat C+E</span>
    </div>
    <div class="hr-badge">üîí Tylko dla HR</div>
  </div>
</header>

<main>
  <div class="loading-screen" id="loadingScreen">
    <div class="loading-spinner"></div>
    <p style="color:var(--text-muted);font-size:13px;letter-spacing:1px">≈Åadowanie danych kandydata...</p>
    <p style="color:var(--text-muted);font-size:11px;margin-top:8px" id="loadingDetail"></p>
  </div>

  <div class="error-screen" id="errorScreen">
    <div style="font-size:56px;margin-bottom:16px">‚ö†Ô∏è</div>
    <div class="error-title">B≈ÇƒÖd ≈Çadowania</div>
    <div class="error-text" id="errorText"></div>
    <div style="margin-top:20px">
      <button onclick="location.reload()" style="background:var(--primary);color:#000;border:none;padding:10px 24px;border-radius:6px;cursor:pointer;font-weight:700">Od≈õwie≈º</button>
    </div>
  </div>

  <div id="formWrapper" style="display:none">
    <div class="page-title">Ocena Kandydata <span>HR</span></div>
    <div class="page-sub">Formularz wewnƒôtrzny ¬∑ Tylko do u≈ºytku dzia≈Çu HR</div>

    <div class="candidate-card">
      <div class="card-header">
        <div>
          <div class="card-name" id="c_name">‚Äî</div>
          <div class="card-ref" id="c_ref">Nr ref: ‚Äî</div>
        </div>
        <div class="status-pill status-new" id="c_status_badge">Nowy</div>
      </div>
      <div class="info-grid" id="candidateGrid"></div>
    </div>

    <form id="hrForm" novalidate>
      <input type="hidden" id="h_itemId" name="itemId">
      <input type="hidden" id="h_refId"  name="referenceId">
      <input type="hidden" id="h_name"   name="candidateName">

      <div class="section">
        <div class="section-header"><span class="section-num">01</span><span class="section-label">Status Rekrutacji</span></div>
        <div class="section-body">
          <div class="field-group" id="fg_status">
            <label class="field-label">Aktualny status <span class="req">*</span></label>
            <div class="options-grid cols-2">
              <label class="option-item" onclick="pickRadio(this)"><input type="radio" name="status_rekrutacji" value="Nowy"><span class="radio-box"></span><span class="option-label">üÜï Nowy</span></label>
              <label class="option-item" onclick="pickRadio(this)"><input type="radio" name="status_rekrutacji" value="W trakcie weryfikacji"><span class="radio-box"></span><span class="option-label">üîç W trakcie weryfikacji</span></label>
              <label class="option-item" onclick="pickRadio(this)"><input type="radio" name="status_rekrutacji" value="Zaproszony na rozmowƒô"><span class="radio-box"></span><span class="option-label">üìÖ Zaproszony na rozmowƒô</span></label>
              <label class="option-item" onclick="pickRadio(this)"><input type="radio" name="status_rekrutacji" value="Po rozmowie"><span class="radio-box"></span><span class="option-label">‚úÖ Po rozmowie</span></label>
              <label class="option-item" onclick="pickRadio(this)"><input type="radio" name="status_rekrutacji" value="Oczekuje na dokumenty"><span class="radio-box"></span><span class="option-label">üìã Oczekuje na dokumenty</span></label>
              <label class="option-item" onclick="pickRadio(this)"><input type="radio" name="status_rekrutacji" value="Wstrzymany"><span class="radio-box"></span><span class="option-label">‚è∏Ô∏è Wstrzymany</span></label>
            </div>
            <div class="field-error">Wybierz status</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header"><span class="section-num">02</span><span class="section-label">Rozmowa Kwalifikacyjna</span></div>
        <div class="section-body">
          <div class="field-row col-2">
            <div class="field-group" id="fg_interview_date">
              <label class="field-label">Data rozmowy <span class="req">*</span></label>
              <input type="date" name="data_rozmowy" id="interviewDate">
              <div class="field-error">Podaj datƒô</div>
            </div>
            <div class="field-group">
              <label class="field-label">Forma rozmowy</label>
              <select name="forma_rozmowy">
                <option value="">‚Äî wybierz ‚Äî</option>
                <option>Telefoniczna</option>
                <option>Wideo (Teams/Zoom)</option>
                <option>Osobista</option>
              </select>
            </div>
          </div>
          <div class="field-group">
            <label class="field-label">ProwadzƒÖcy rozmowƒô</label>
            <input type="text" name="prowadzacy" placeholder="Imiƒô i nazwisko rekrutera">
          </div>
          <div class="field-group">
            <label class="field-label">Ocena kandydata (1‚Äì5)</label>
            <div class="rating-row">
              <span class="star" onclick="setRating(1)">‚òÖ</span>
              <span class="star" onclick="setRating(2)">‚òÖ</span>
              <span class="star" onclick="setRating(3)">‚òÖ</span>
              <span class="star" onclick="setRating(4)">‚òÖ</span>
              <span class="star" onclick="setRating(5)">‚òÖ</span>
            </div>
            <div class="rating-label" id="ratingLabel">Kliknij aby oceniƒá</div>
            <input type="hidden" name="ocena_gwiazdki" id="ratingVal" value="0">
          </div>
          <div class="field-group">
            <label class="field-label">Weryfikacja podczas rozmowy</label>
            <div class="checklist">
              <div class="check-row"><span class="check-row-label">Do≈õwiadczenie potwierdzone rozmowƒÖ</span><div class="check-toggle"><input type="radio" name="chk_exp" id="ce_y" value="Tak"><label for="ce_y" class="yes-lbl">TAK</label><input type="radio" name="chk_exp" id="ce_n" value="Nie"><label for="ce_n" class="no-lbl">NIE</label></div></div>
              <div class="check-row"><span class="check-row-label">Dokumenty zweryfikowane</span><div class="check-toggle"><input type="radio" name="chk_docs" id="cd_y" value="Tak"><label for="cd_y" class="yes-lbl">TAK</label><input type="radio" name="chk_docs" id="cd_n" value="Nie"><label for="cd_n" class="no-lbl">NIE</label></div></div>
              <div class="check-row"><span class="check-row-label">Znajomo≈õƒá tras europejskich</span><div class="check-toggle"><input type="radio" name="chk_routes" id="cr_y" value="Tak"><label for="cr_y" class="yes-lbl">TAK</label><input type="radio" name="chk_routes" id="cr_n" value="Nie"><label for="cr_n" class="no-lbl">NIE</label></div></div>
              <div class="check-row"><span class="check-row-label">Dyspozycyjno≈õƒá zgodna z wymaganiami</span><div class="check-toggle"><input type="radio" name="chk_avail" id="ca_y" value="Tak"><label for="ca_y" class="yes-lbl">TAK</label><input type="radio" name="chk_avail" id="ca_n" value="Nie"><label for="ca_n" class="no-lbl">NIE</label></div></div>
            </div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header"><span class="section-num">03</span><span class="section-label">Uwagi HR</span></div>
        <div class="section-body">
          <div class="field-group">
            <label class="field-label">Notatki z rozmowy</label>
            <textarea name="uwagi_hr" placeholder="Spostrze≈ºenia, wra≈ºenia, wa≈ºne informacje..."></textarea>
          </div>
          <div class="field-group">
            <label class="field-label">Proponowane warunki zatrudnienia</label>
            <textarea name="warunki" placeholder="Stawka, trasy, termin rozpoczƒôcia..." style="min-height:60px"></textarea>
          </div>
          <div class="field-group">
            <label class="field-label">Kolejne kroki</label>
            <input type="text" name="kolejne_kroki" placeholder="np. Wys≈Çaƒá umowƒô, uzupe≈Çniƒá KOD 95...">
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-header"><span class="section-num">04</span><span class="section-label">Decyzja Ko≈Ñcowa</span></div>
        <div class="section-body">
          <label class="field-label">Decyzja HR <span class="req">*</span></label>
          <div class="decision-grid">
            <label class="decision-btn accept" onclick="pickDecision(this,'Przyjƒôty')"><input type="radio" name="decyzja" value="Przyjƒôty"><span>‚úÖ</span> Przyjƒôty</label>
            <label class="decision-btn reject" onclick="pickDecision(this,'Odrzucony')"><input type="radio" name="decyzja" value="Odrzucony"><span>‚ùå</span> Odrzucony</label>
          </div>
          <div class="field-error" id="decyzja_error" style="margin-top:8px">Wybierz decyzjƒô</div>
          <div id="rejectReasonBlock" style="display:none;margin-top:14px">
            <label class="field-label">Pow√≥d odrzucenia</label>
            <select name="powod_odrzucenia">
              <option value="">‚Äî wybierz ‚Äî</option>
              <option>NiewystarczajƒÖce do≈õwiadczenie</option>
              <option>Brak wymaganych dokument√≥w</option>
              <option>Kandydat zrezygnowa≈Ç</option>
              <option>Brak odpowiedzi kandydata</option>
              <option>Nie spe≈Çnia wymaga≈Ñ jƒôzykowych</option>
              <option>Inne</option>
            </select>
          </div>
          <div id="acceptBlock" style="display:none;margin-top:14px">
            <label class="field-label">Planowana data rozpoczƒôcia</label>
            <input type="date" name="data_rozpoczecia">
          </div>
        </div>
      </div>

      <div class="submit-area">
        <button type="submit" class="submit-btn" id="submitBtn">
          <div class="spinner"></div>
          <span class="btn-text">üíæ Zapisz ocenƒô HR</span>
        </button>
        <div style="margin-top:12px;font-size:11px;color:var(--text-muted)">Dane zostanƒÖ zapisane w SharePoint ¬∑ Lista Kandydaci_CE</div>
      </div>

      <div class="upload-progress" id="uploadProgress">
        <div class="upload-progress-title">‚öôÔ∏è Zapisywanie...</div>
        <div class="upload-step"><span class="step-icon" id="icon_v">1</span><span class="step-label" id="label_v">Weryfikacja danych</span></div>
        <div class="upload-step"><span class="step-icon" id="icon_g">2</span><span class="step-label" id="label_g">Pobieranie danych kandydata</span></div>
        <div class="upload-step"><span class="step-icon" id="icon_s">3</span><span class="step-label" id="label_s">Zapisywanie oceny w SharePoint</span></div>
      </div>
    </form>
  </div>

  <div class="success-screen" id="successScreen">
    <div class="success-icon">‚úÖ</div>
    <div class="success-title">Zapisano!</div>
    <p class="success-text">Ocena kandydata zosta≈Ça zaktualizowana w SharePoint.</p>
    <p style="color:var(--text-muted);font-size:13px;margin-top:16px" id="successDetail"></p>
  </div>
</main>

<div class="toast" id="toast">
  <span class="toast-icon" id="toastIcon"></span>
  <div class="toast-body"><div class="toast-title" id="toastTitle"></div><div class="toast-msg" id="toastMsg"></div></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  KONFIGURACJA ‚Äì wklej URL swoich Flow poni≈ºej
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Flow GET ‚Äì pobiera dane kandydata z SharePoint po itemId
// Trigger: HTTP request ‚Üí Pobierz element SP ‚Üí Response z JSON
const GET_URL = "https://defaulta4f7df2f758045869110563ac360d2.69.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/74727b0ba96d489588692a2ce39f8a5b/triggers/manual/paths/invoke?api-version=1";

// Flow POST ‚Äì zapisuje ocenƒô HR do SharePoint
// Trigger: HTTP request ‚Üí Aktualizuj element SP ‚Üí Response 200
const POST_URL = "https://defaulta4f7df2f758045869110563ac360d2.69.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/1e57689babeb403da00204d283c6d7a8/triggers/manual/paths/invoke?api-version=1";

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const ratingLabels = ["","S≈Çaby","Poni≈ºej oczekiwa≈Ñ","Przeciƒôtny","Dobry","Doskona≈Çy"];

window.addEventListener('DOMContentLoaded', async () => {
  const p      = new URLSearchParams(window.location.search);
  const itemId = p.get('itemId') || p.get('id');
  const refId  = p.get('ref') || '';

  if (!itemId) {
    showDemo();
    return;
  }

  document.getElementById('h_itemId').value = itemId;
  document.getElementById('h_refId').value  = refId;
  document.getElementById('loadingDetail').textContent = `≈Åadowanie rekordu ID: ${itemId}`;

  // Tryb demo je≈õli Flow GET nie jest skonfigurowany
  if (GET_URL === 'WKLEJ_URL_FLOW_GET') {
    showDemoWithId(itemId, refId);
    return;
  }

  try {
    const resp = await fetch(`${GET_URL}&itemId=${encodeURIComponent(itemId)}`, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' }
    });
    if (!resp.ok) throw new Error(`Flow GET zwr√≥ci≈Ç HTTP ${resp.status}`);
    const data = await resp.json();
    renderCandidate(data, itemId, refId);
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('formWrapper').style.display = 'block';
  } catch(err) {
    document.getElementById('loadingScreen').classList.add('hidden');
    document.getElementById('errorScreen').classList.add('visible');
    document.getElementById('errorText').innerHTML =
      `<strong>${err.message}</strong><br><br>` +
      `Sprawd≈∫ czy Flow GET jest poprawnie skonfigurowany i czy URL jest aktualny.`;
  }
});

function renderCandidate(d, itemId, refId) {
  // Obs≈Çuguje dane zar√≥wno z Flow (nazwy z ankiety) jak i bezpo≈õrednio z SP
  const g = (...keys) => {
    for (const k of keys) {
      const v = d[k];
      if (v !== undefined && v !== null && v !== '') return String(v);
    }
    return '‚Äî';
  };

  const name    = g('full_name','Kandydat_Nazwiskolmie','Title');
  const nat     = g('nationality','Kandydat_Narodowosc');
  const email   = g('email','Kandydat_Email','Email');
  const tel     = g('phone_pl','Kandydat_Telefon_PL');
  const telOth  = g('phone_other','Kandydat_Telefon_zagraniczny');
  const exp     = g('experience','Doswiadczenie_CE');
  const trailer = g('trailers','Typ_Naczepy');
  const lic     = g('license_type','Prawo_Jazdy');
  const langs   = g('languages','Jezyki');
  const res     = g('residence_doc','Dokument_Pobyt');
  const ref     = g('referenceId','Title') || refId;
  const date    = g('submittedAt','Data_Zlozenia','Created');

  document.getElementById('c_name').textContent = name;
  document.getElementById('c_ref').textContent  = 'Nr ref: ' + ref;
  document.getElementById('h_name').value       = name;
  document.getElementById('h_itemId').value     = itemId || d.ID || d.id || '';

  const expMap = {'1-3m':'1‚Äì3 mies.','3-6m':'3‚Äì6 mies.','6-12m':'6‚Äì12 mies.','12m+':'12+ mies.'};
  const resMap = {'visa':'Wiza üõÇ','karta_pobytu':'Karta pobytu ü™™'};
  const licMap = {'pl':'Polskie üáµüá±','foreign':'Zagraniczne'};
  const dateStr = date !== '‚Äî' ? (() => { try { return new Date(date).toLocaleDateString('pl-PL'); } catch(e) { return date; }})() : '‚Äî';

  document.getElementById('candidateGrid').innerHTML = `
    <div><div class="info-label">Narodowo≈õƒá</div><div class="info-value highlight">${nat}</div></div>
    <div><div class="info-label">E-mail</div><div class="info-value">${email}</div></div>
    <div><div class="info-label">Telefon PL</div><div class="info-value">${tel}</div></div>
    <div><div class="info-label">Tel. zagraniczny</div><div class="info-value">${telOth}</div></div>
    <div><div class="info-label">Do≈õwiadczenie C+E</div><div class="info-value highlight">${expMap[exp]||exp}</div></div>
    <div><div class="info-label">Typ naczepy</div><div class="info-value">${trailer}</div></div>
    <div><div class="info-label">Prawo jazdy</div><div class="info-value">${licMap[lic]||lic}</div></div>
    <div><div class="info-label">Jƒôzyki</div><div class="info-value">${langs}</div></div>
    <div><div class="info-label">Dokument pobytowy</div><div class="info-value">${resMap[res]||res}</div></div>
    <div><div class="info-label">Data zg≈Çoszenia</div><div class="info-value">${dateStr}</div></div>
  `;
}

function showDemo() {
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('errorScreen').classList.add('visible');
  document.getElementById('errorText').innerHTML =
    `Brak parametru <code>itemId</code> w URL.<br><br>` +
    `Otw√≥rz formularz przez link z emaila HR kt√≥ry zawiera<br>` +
    `<code>?itemId=X&ref=HT-CE-...</code>`;
}

function showDemoWithId(itemId, refId) {
  renderCandidate({
    full_name: 'Tryb DEMO ‚Äì skonfiguruj Flow GET',
    nationality: 'Ukrai≈Ñska', email: 'demo@example.com',
    phone_pl: '+48 600 000 000', experience: '12m+',
    trailers: 'silos, plandeka', license_type: 'pl',
    languages: 'pl, uk', residence_doc: 'karta_pobytu',
    submittedAt: new Date().toISOString()
  }, itemId, refId);
  document.getElementById('loadingScreen').classList.add('hidden');
  document.getElementById('formWrapper').style.display = 'block';
  showToast('warn','‚ö†Ô∏è','Tryb DEMO',`itemId=${itemId} ¬∑ Skonfiguruj GET_URL w kodzie`);
}

// SUBMIT
document.getElementById('hrForm').addEventListener('submit', async function(e) {
  e.preventDefault();

  const statusEl  = document.querySelector('[name="status_rekrutacji"]:checked');
  const dateVal   = document.getElementById('interviewDate').value;
  const decyzjaEl = document.querySelector('[name="decyzja"]:checked');
  let ok = true;

  document.getElementById('fg_status').classList.toggle('has-error', !statusEl);
  document.getElementById('fg_interview_date').classList.toggle('has-error', !dateVal);
  document.getElementById('decyzja_error').style.display = decyzjaEl ? 'none' : 'block';
  if (!statusEl || !dateVal || !decyzjaEl) ok = false;
  if (!ok) { showToast('error','‚ùå','Uzupe≈Çnij formularz','Wymagane pola sƒÖ puste.'); return; }

  const btn = document.getElementById('submitBtn');
  btn.disabled = true; btn.classList.add('loading');
  document.getElementById('uploadProgress').classList.add('visible');
  document.getElementById('uploadProgress').scrollIntoView({behavior:'smooth',block:'start'});

  const f = this;
  const payload = {
    itemId:            document.getElementById('h_itemId').value,
    referenceId:       document.getElementById('h_refId').value,
    candidateName:     document.getElementById('h_name').value,
    status_rekrutacji: statusEl.value,
    data_rozmowy:      dateVal,
    forma_rozmowy:     f.forma_rozmowy?.value || '',
    prowadzacy:        f.prowadzacy?.value || '',
    ocena_gwiazdki:    f.ocena_gwiazdki?.value || '0',
    chk_exp:           document.querySelector('[name="chk_exp"]:checked')?.value || '',
    chk_docs:          document.querySelector('[name="chk_docs"]:checked')?.value || '',
    chk_routes:        document.querySelector('[name="chk_routes"]:checked')?.value || '',
    chk_avail:         document.querySelector('[name="chk_avail"]:checked')?.value || '',
    uwagi_hr:          f.uwagi_hr?.value || '',
    warunki:           f.warunki?.value || '',
    kolejne_kroki:     f.kolejne_kroki?.value || '',
    decyzja:           decyzjaEl.value,
    powod_odrzucenia:  f.powod_odrzucenia?.value || '',
    data_rozpoczecia:  f.data_rozpoczecia?.value || '',
    hr_submitted_at:   new Date().toISOString()
  };

  try {
    setStep('v','running','Weryfikacja danych...');
    await sleep(300);
    setStep('v','done','Dane poprawne ‚úì');

    setStep('g','running','≈ÅƒÖczenie z SharePoint...');
    await sleep(200);
    setStep('g','done','Po≈ÇƒÖczono ‚úì');

    setStep('s','running','Zapisywanie oceny...');

    if (POST_URL === 'WKLEJ_URL_FLOW_POST') {
      await sleep(800);
      setStep('s','done','(DEMO) Symulacja zapisu ‚úì');
    } else {
      const resp = await fetch(POST_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!resp.ok) throw new Error(`Flow POST zwr√≥ci≈Ç HTTP ${resp.status}`);
      setStep('s','done','Zapisano w SharePoint ‚úì');
    }

    setTimeout(() => {
      document.getElementById('formWrapper').style.display = 'none';
      document.getElementById('successScreen').classList.add('visible');
      document.getElementById('successDetail').textContent =
        `Kandydat: ${payload.candidateName} ¬∑ Decyzja: ${payload.decyzja} ¬∑ Status: ${payload.status_rekrutacji}`;
      window.scrollTo({top:0,behavior:'smooth'});
    }, 700);

  } catch(err) {
    console.error(err);
    ['v','g','s'].forEach(id => {
      if (document.getElementById('icon_'+id)?.classList.contains('running'))
        setStep(id,'fail','B≈ÇƒÖd');
    });
    btn.disabled = false; btn.classList.remove('loading');
    showToast('error','‚ùå','B≈ÇƒÖd zapisu', err.message);
  }
});

function pickRadio(lbl) {
  const inp = lbl.querySelector('input');
  document.querySelectorAll(`[name="${inp.name}"]`).forEach(r => r.closest('.option-item')?.classList.remove('checked'));
  lbl.classList.add('checked'); inp.checked = true;
  lbl.closest('.field-group')?.classList.remove('has-error');
}
function pickDecision(lbl, val) {
  document.querySelectorAll('.decision-btn').forEach(b => b.classList.remove('selected'));
  lbl.classList.add('selected'); lbl.querySelector('input').checked = true;
  document.getElementById('decyzja_error').style.display = 'none';
  document.getElementById('rejectReasonBlock').style.display = val === 'Odrzucony' ? 'block' : 'none';
  document.getElementById('acceptBlock').style.display       = val === 'Przyjƒôty'  ? 'block' : 'none';
  const badge = document.getElementById('c_status_badge');
  badge.className  = 'status-pill ' + (val === 'Przyjƒôty' ? 'status-accepted' : 'status-rejected');
  badge.textContent = val;
}
function setRating(v) {
  document.getElementById('ratingVal').value = v;
  document.getElementById('ratingLabel').textContent = `${v}/5 ‚Äì ${ratingLabels[v]}`;
  document.querySelectorAll('.star').forEach((s,i) => s.classList.toggle('active', i < v));
}
function setStep(id, state, label) {
  const icon = document.getElementById('icon_'+id), lbl = document.getElementById('label_'+id);
  if (!icon||!lbl) return;
  icon.className   = 'step-icon '+state;
  icon.textContent = {running:'‚ü≥',done:'‚úì',fail:'‚úó'}[state]||id;
  lbl.textContent  = label; lbl.className = 'step-label '+state;
}
let toastTimer;
function showToast(type,icon,title,msg) {
  const t = document.getElementById('toast');
  document.getElementById('toastIcon').textContent  = icon;
  document.getElementById('toastTitle').textContent = title;
  document.getElementById('toastMsg').textContent   = msg;
  t.className = `toast toast-${type} show`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 7000);
}
const sleep = ms => new Promise(r => setTimeout(r, ms));
</script>
</body>
</html>
